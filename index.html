<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged, updateProfile,
    createUserWithEmailAndPassword, signInWithEmailAndPassword,
    EmailAuthProvider, linkWithCredential, signOut, setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD37Lc_tHwEkmXSHwDr6QUTNeWXGOKAftg",
    authDomain: "dodger-4aad1.firebaseapp.com",
    projectId: "dodger-4aad1",
    storageBucket: "dodger-4aad1.appspot.com",
    messagingSenderId: "148070811748",
    appId: "1:148070811748:web:1ed51b4872b9d9106b3771",
    measurementId: "G-NV3R6CEYH7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Persist across reloads (including anonymous)
  await setPersistence(auth, browserLocalPersistence);

  // Sign in as guest immediately (fast start). This user is later "upgraded" if they register.
  signInAnonymously(auth).catch(console.warn);

  const chip = document.getElementById('userChip');
  const loginBtn  = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  // Modal elems
  const authModal  = document.getElementById('authModal');
  const authClose  = document.getElementById('authClose');
  const authTitle  = document.getElementById('authTitle');
  const authEmail  = document.getElementById('authEmail');
  const authPass   = document.getElementById('authPass');
  const authToggle = document.getElementById('authToggle');
  const authSubmit = document.getElementById('authSubmit');
  const authMsg    = document.getElementById('authMsg');

  let mode = 'login'; // or 'signup'

  function openAuth(){ authMsg.textContent = ""; authModal.style.display = "flex"; }
  function closeAuth(){ authModal.style.display = "none"; }
  loginBtn.addEventListener('pointerdown', e => { e.preventDefault(); mode='login'; authTitle.textContent='Log in'; authSubmit.textContent='Log in'; authToggle.textContent='Need an account?'; openAuth(); });
  logoutBtn.addEventListener('pointerdown', async e => { e.preventDefault(); await signOut(auth); });
  authClose.addEventListener('pointerdown', e => { e.preventDefault(); closeAuth(); });
  authToggle.addEventListener('pointerdown', e => {
    e.preventDefault();
    if (mode === 'login') { mode='signup'; authTitle.textContent='Create account'; authSubmit.textContent='Sign up'; authToggle.textContent='Have an account?'; }
    else { mode='login'; authTitle.textContent='Log in'; authSubmit.textContent='Log in'; authToggle.textContent='Need an account?'; }
  });

  async function doAuth() {
    authMsg.textContent = "";
    const email = authEmail.value.trim();
    const pass  = authPass.value;
    if (!email || !pass) { authMsg.textContent = "Enter email and password."; return; }

    try {
      if (mode === 'signup') {
        // If currently anonymous, link it so the UID (and scores) stay the same.
        if (auth.currentUser && auth.currentUser.isAnonymous) {
          const cred = EmailAuthProvider.credential(email, pass);
          await linkWithCredential(auth.currentUser, cred);
        } else {
          await createUserWithEmailAndPassword(auth, email, pass);
        }
        // Set a default display name from email (before @)
        const name = email.split('@')[0].slice(0,24);
        if (auth.currentUser && !auth.currentUser.displayName) {
          await updateProfile(auth.currentUser, { displayName: name });
        }
      } else {
        await signInWithEmailAndPassword(auth, email, pass);
      }
      closeAuth();
    } catch (err) {
      authMsg.textContent = err.message || String(err);
    }
  }
  authSubmit.addEventListener('pointerdown', e => { e.preventDefault(); doAuth(); });

  onAuthStateChanged(auth, (u) => {
    if (!chip) return;
    if (u) {
      chip.textContent = u.displayName ? `Signed in as ${u.displayName}` : (u.isAnonymous ? 'Guest (not saved)' : 'Signed in');
      loginBtn.style.display  = u.isAnonymous ? 'inline-block' : 'none';
      logoutBtn.style.display = u.isAnonymous ? 'none' : 'inline-block';
    } else {
      chip.textContent = 'Not signed in';
      loginBtn.style.display  = 'inline-block';
      logoutBtn.style.display = 'none';
    }
  });

  // Expose helpers used by the game/leaderboard
  window.firebase = {
    auth, db,
    onUser(cb){ return onAuthStateChanged(auth, cb); },
    async setDisplayName(name){
      if (!auth.currentUser) return;
      const clean = String(name||"Player").trim().slice(0,24);
      await updateProfile(auth.currentUser, { displayName: clean });
      return clean;
    },
    async saveScore(score){
      if (!auth.currentUser) return { ok:false, error:"Not signed in" };
      try{
        await addDoc(collection(db,"scores"),{
          uid:auth.currentUser.uid,
          name:auth.currentUser.displayName||"Player",
          score: Math.floor(Number(score)||0),
          ts: serverTimestamp()
        });
        return { ok:true };
      }catch(e){ return { ok:false, error:e.message }; }
    },
    async loadTop(n=20){
      const qy = query(collection(db,"scores"), orderBy("score","desc"), limit(n));
      const snap = await getDocs(qy);
      return snap.docs.map(d => ({ id:d.id, ...d.data() }));
    }
  };
</script>